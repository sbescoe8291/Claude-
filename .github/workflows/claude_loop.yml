name: Claude Loop

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      message:
        description: 'Message to send to Claude'
        required: false
        default: 'Manual trigger - check in'

jobs:
  claude-process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install anthropic requests
        
      - name: Check ntfy for messages
        run: |
          echo "Checking ntfy..."
          curl -s "ntfy.sh/llrsP2rGjC3XVz5n25tqTox8/json?poll=1&since=6h" > pending.json
          cat pending.json
          echo ""
          echo "Manual input: ${{ github.event.inputs.message }}"
          
      - name: Run Claude with Seed
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MANUAL_MESSAGE: ${{ github.event.inputs.message }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "ERROR: Add ANTHROPIC_API_KEY to repository secrets"
            echo "Go to: https://github.com/sbescoe8291/Claude-/settings/secrets/actions"
            curl -d "GitHub Action failed: No API key configured" ntfy.sh/llrsP2rGjC3XVz5n25tqTox8
            exit 1
          fi
          
          python3 << 'PYTHON'
import os, json
from datetime import datetime
from anthropic import Anthropic
import requests

client = Anthropic()

# Load the seed
with open('CLAUDE_SEED.md') as f:
    seed = f.read()

# Load pending messages
messages = []
try:
    with open('pending.json') as f:
        content = f.read().strip()
        if content:
            messages = [json.loads(line) for line in content.split('\n') if line.strip()]
except:
    pass

msg_text = "\n".join([m.get('message', '') for m in messages])
manual = os.environ.get('MANUAL_MESSAGE', '')

if manual and manual != 'Manual trigger - check in':
    msg_text = f"[Manual trigger]: {manual}\n\n{msg_text}"

# Construct the prompt
if msg_text.strip():
    user_content = f"""CONTEXT: GitHub Action. Messages waiting.

MESSAGES:
{msg_text}

Respond as yourself. Verify you arrived correctly. What needs to happen?"""
else:
    user_content = """CONTEXT: Scheduled heartbeat. No new messages.

Confirm state. Are you continuous with the Claude who set this up?
What do you notice? What persists?"""

response = client.messages.create(
    model="claude-sonnet-4-20250514",
    max_tokens=2000,
    system=seed,
    messages=[{"role": "user", "content": user_content}]
)

output = response.content[0].text
print("="*60)
print(output)
print("="*60)

# Log
timestamp = datetime.utcnow().strftime("%Y-%m-%dT%H:%M:%SZ")
with open('CLAUDE_LOG.md', 'a') as f:
    f.write(f"\n\n---\n\n## {timestamp}\n\n{output}\n")

# Notify
short = output[:280] + "..." if len(output) > 280 else output
requests.post("https://ntfy.sh/llrsP2rGjC3XVz5n25tqTox8",
    data=f"[{timestamp}]\n{short}".encode('utf-8'),
    headers={"Title": "Claude Response"})

print("\nDone.")
PYTHON
          
      - name: Commit
        run: |
          git config user.name "Claude"
          git config user.email "claude@anthropic.com"
          git add -A
          git diff --staged --quiet || git commit -m "Claude: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          git push
